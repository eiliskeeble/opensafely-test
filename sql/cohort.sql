-- Query for date_of_death
SELECT * INTO #date_of_death FROM (
        SELECT
          ONS_Deaths.Patient_ID as patient_id,
          MIN(dod) AS date_of_death
        FROM ONS_Deaths
        
        WHERE (1 = 1) AND CAST(dod AS date) BETWEEN CAST('20190601' AS date) AND CAST('20210228' AS date)
        GROUP BY ONS_Deaths.Patient_ID
        ) t
GO

CREATE CLUSTERED INDEX patient_id_ix ON #date_of_death (patient_id)
GO

-- Query for died_in_p1
SELECT * INTO #died_in_p1 FROM (
        SELECT
          ONS_Deaths.Patient_ID as patient_id,
          1 AS binary_flag
        FROM ONS_Deaths
        
        WHERE (1 = 1) AND CAST(dod AS date) BETWEEN CAST('20190601' AS date) AND CAST('20200229' AS date)
        GROUP BY ONS_Deaths.Patient_ID
        ) t
GO

CREATE CLUSTERED INDEX patient_id_ix ON #died_in_p1 (patient_id)
GO

-- Query for died_in_p2
SELECT * INTO #died_in_p2 FROM (
        SELECT
          ONS_Deaths.Patient_ID as patient_id,
          1 AS binary_flag
        FROM ONS_Deaths
        
        WHERE (1 = 1) AND CAST(dod AS date) BETWEEN CAST('20200601' AS date) AND CAST('20210228' AS date)
        GROUP BY ONS_Deaths.Patient_ID
        ) t
GO

CREATE CLUSTERED INDEX patient_id_ix ON #died_in_p2 (patient_id)
GO


            -- Uploading codelist for dmd_1
            CREATE TABLE #tmp1_dmd_1_codelist (
              code VARCHAR(17) COLLATE Latin1_General_CI_AS NOT NULL PRIMARY KEY,
              category VARCHAR(MAX)
            )
            
GO

INSERT INTO [#tmp1_dmd_1_codelist] ([code], [category]) VALUES
('30947711000001109', ''),
('32480111000001109', ''),
('30823211000001100', ''),
('20418211000001106', ''),
('38895711000001103', ''),
('4049611000001100', ''),
('36125011000001107', ''),
('36128711000001102', ''),
('3246911000001106', ''),
('36128911000001100', ''),
('36130611000001105', ''),
('23958211000001100', ''),
('27953111000001108', ''),
('37995911000001103', ''),
('4383211000001109', ''),
('14729811000001104', ''),
('4048411000001106', ''),
('3880111000001105', ''),
('35537611000001103', ''),
('4486811000001107', ''),
('9750511000001106', ''),
('37761311000001108', ''),
('12333211000001105', ''),
('3242611000001101', ''),
('12058611000001102', ''),
('36124911000001107', ''),
('10066311000001109', ''),
('21555311000001103', ''),
('36125411000001103', ''),
('4486111000001100', ''),
('12391111000001109', ''),
('35576611000001103', ''),
('21627711000001101', ''),
('3385011000001100', ''),
('36128211000001109', ''),
('37760911000001102', ''),
('4383611000001106', ''),
('11487811000001104', ''),
('22401911000001100', ''),
('37995711000001100', ''),
('3245411000001107', ''),
('3383311000001103', ''),
('35584011000001106', ''),
('12391011000001108', ''),
('4476511000001102', ''),
('4477511000001100', ''),
('4049411000001103', ''),
('15545411000001108', ''),
('21579911000001102', ''),
('37605211000001106', ''),
('23430411000001100', ''),
('23430611000001102', ''),
('4636011000001109', ''),
('20419411000001102', ''),
('21678411000001105', ''),
('4478911000001108', ''),
('21540711000001107', ''),
('37761111000001106', ''),
('3384011000001104', ''),
('7978111000001104', ''),
('4508111000001108', ''),
('4182911000001102', ''),
('21507711000001104', ''),
('21579811000001107', ''),
('36128511000001107', ''),
('12391211000001103', ''),
('3247411000001101', ''),
('3245711000001101', ''),
('12334711000001101', ''),
('4045011000001105', ''),
('15613611000001105', ''),
('3880411000001100', ''),
('22402211000001102', ''),
('8436411000001104', ''),
('4752011000001100', ''),
('35537411000001101', ''),
('36053511000001109', ''),
('12335511000001107', ''),
('20275911000001102', ''),
('3879511000001101', ''),
('31994411000001107', ''),
('4046311000001103', ''),
('7977911000001102', ''),
('3823111000001108', ''),
('11055111000001104', ''),
('24403511000001100', ''),
('12391611000001101', ''),
('38895511000001108', ''),
('4477011000001108', ''),
('9748311000001100', ''),
('17474611000001104', ''),
('35537811000001104', ''),
('10075511000001100', ''),
('12332811000001103', ''),
('19710611000001103', ''),
('12336111000001109', ''),
('20507011000001107', ''),
('36641311000001105', ''),
('38896111000001105', ''),
('27858211000001101', ''),
('5104211000001105', ''),
('37388311000001100', ''),
('11488111000001107', ''),
('4486511000001109', ''),
('12391411000001104', ''),
('23607911000001102', ''),
('19711411000001105', ''),
('19711211000001106', ''),
('28991411000001100', ''),
('20275411000001105', ''),
('36125511000001104', ''),
('10679811000001109', ''),
('24403711000001105', ''),
('22658511000001107', ''),
('10679511000001106', ''),
('4383011000001104', ''),
('12329211000001109', ''),
('10678011000001108', ''),
('12333611000001107', ''),
('13845011000001105', ''),
('34025611000001102', ''),
('12059111000001103', ''),
('36640411000001107', ''),
('12391811000001102', ''),
('10681711000001109', ''),
('30996711000001101', ''),
('12332111000001105', ''),
('15248511000001106', ''),
('22083811000001104', ''),
('14730811000001105', ''),
('29745511000001101', ''),
('5104411000001109', ''),
('36125211000001102', ''),
('22827711000001106', ''),
('4047011000001103', ''),
('29746211000001105', ''),
('11055311000001102', ''),
('4046711000001104', ''),
('23939011000001104', ''),
('10065911000001103', ''),
('37901111000001101', ''),
('3879711000001106', ''),
('22154711000001106', ''),
('4635211000001105', ''),
('12391311000001106', ''),
('34026211000001105', ''),
('36129811000001103', ''),
('12329811000001105', ''),
('23430811000001103', ''),
('4047511000001106', ''),
('4383411000001108', ''),
('28797311000001109', ''),
('10679011000001103', ''),
('17474211000001101', ''),
('35576911000001109', ''),
('13845211000001100', ''),
('21636011000001103', ''),
('37996111000001107', ''),
('38895311000001102', ''),
('30823411000001101', ''),
('20227811000001101', ''),
('4000811000001101', ''),
('36044111000001101', ''),
('12391711000001105', ''),
('10267411000001105', ''),
('10684411000001101', ''),
('19671011000001103', ''),
('30994611000001101', ''),
('4478411000001100', ''),
('4752311000001102', ''),
('23939211000001109', ''),
('34025811000001103', ''),
('4485911000001109', ''),
('5104011000001100', ''),
('4382711000001105', ''),
('10267211000001106', ''),
('4476211000001100', ''),
('10681911000001106', ''),
('4048911000001103', ''),
('12390811000001105', ''),
('3385311000001102', ''),
('19671211000001108', ''),
('4049211000001102', ''),
('20506811000001103', ''),
('28797911000001105', ''),
('28991211000001104', ''),
('19723011000001106', '')
GO

-- Query for dmd_1
SELECT * INTO #dmd_1 FROM (
            SELECT
              MedicationIssue.Patient_ID AS patient_id,
              1 AS binary_flag,
              MAX(ConsultationDate) AS date
            FROM MedicationIssue
                INNER JOIN MedicationDictionary
                ON MedicationIssue.MultilexDrug_ID = MedicationDictionary.MultilexDrug_ID
                
            INNER JOIN #tmp1_dmd_1_codelist
            ON DMD_ID = #tmp1_dmd_1_codelist.code
            LEFT JOIN #date_of_death
ON #date_of_death.patient_id = MedicationIssue.patient_id
            WHERE CAST(ConsultationDate AS date) BETWEEN CAST(DATEADD(DAY, -30, CAST(#date_of_death.[date_of_death] AS date)) AS date) AND CAST(CAST(#date_of_death.[date_of_death] AS date) AS date)
              AND NOT 0 = 1
              AND 1 = 1
            GROUP BY MedicationIssue.Patient_ID
            ) t
GO

CREATE CLUSTERED INDEX patient_id_ix ON #dmd_1 (patient_id)
GO


            -- Uploading codelist for dmd_3
            CREATE TABLE #tmp2_dmd_3_codelist (
              code VARCHAR(17) COLLATE Latin1_General_CI_AS NOT NULL PRIMARY KEY,
              category VARCHAR(MAX)
            )
            
GO

INSERT INTO [#tmp2_dmd_3_codelist] ([code], [category]) VALUES
('30947711000001109', ''),
('32480111000001109', ''),
('30823211000001100', ''),
('20418211000001106', ''),
('38895711000001103', ''),
('4049611000001100', ''),
('36125011000001107', ''),
('36128711000001102', ''),
('3246911000001106', ''),
('36128911000001100', ''),
('36130611000001105', ''),
('23958211000001100', ''),
('27953111000001108', ''),
('37995911000001103', ''),
('4383211000001109', ''),
('14729811000001104', ''),
('4048411000001106', ''),
('3880111000001105', ''),
('35537611000001103', ''),
('4486811000001107', ''),
('9750511000001106', ''),
('37761311000001108', ''),
('12333211000001105', ''),
('3242611000001101', ''),
('12058611000001102', ''),
('36124911000001107', ''),
('10066311000001109', ''),
('21555311000001103', ''),
('36125411000001103', ''),
('4486111000001100', ''),
('12391111000001109', ''),
('35576611000001103', ''),
('21627711000001101', ''),
('3385011000001100', ''),
('36128211000001109', ''),
('37760911000001102', ''),
('4383611000001106', ''),
('11487811000001104', ''),
('22401911000001100', ''),
('37995711000001100', ''),
('3245411000001107', ''),
('3383311000001103', ''),
('35584011000001106', ''),
('12391011000001108', ''),
('4476511000001102', ''),
('4477511000001100', ''),
('4049411000001103', ''),
('15545411000001108', ''),
('21579911000001102', ''),
('37605211000001106', ''),
('23430411000001100', ''),
('23430611000001102', ''),
('4636011000001109', ''),
('20419411000001102', ''),
('21678411000001105', ''),
('4478911000001108', ''),
('21540711000001107', ''),
('37761111000001106', ''),
('3384011000001104', ''),
('7978111000001104', ''),
('4508111000001108', ''),
('4182911000001102', ''),
('21507711000001104', ''),
('21579811000001107', ''),
('36128511000001107', ''),
('12391211000001103', ''),
('3247411000001101', ''),
('3245711000001101', ''),
('12334711000001101', ''),
('4045011000001105', ''),
('15613611000001105', ''),
('3880411000001100', ''),
('22402211000001102', ''),
('8436411000001104', ''),
('4752011000001100', ''),
('35537411000001101', ''),
('36053511000001109', ''),
('12335511000001107', ''),
('20275911000001102', ''),
('3879511000001101', ''),
('31994411000001107', ''),
('4046311000001103', ''),
('7977911000001102', ''),
('3823111000001108', ''),
('11055111000001104', ''),
('24403511000001100', ''),
('12391611000001101', ''),
('38895511000001108', ''),
('4477011000001108', ''),
('9748311000001100', ''),
('17474611000001104', ''),
('35537811000001104', ''),
('10075511000001100', ''),
('12332811000001103', ''),
('19710611000001103', ''),
('12336111000001109', ''),
('20507011000001107', ''),
('36641311000001105', ''),
('38896111000001105', ''),
('27858211000001101', ''),
('5104211000001105', ''),
('37388311000001100', ''),
('11488111000001107', ''),
('4486511000001109', ''),
('12391411000001104', ''),
('23607911000001102', ''),
('19711411000001105', ''),
('19711211000001106', ''),
('28991411000001100', ''),
('20275411000001105', ''),
('36125511000001104', ''),
('10679811000001109', ''),
('24403711000001105', ''),
('22658511000001107', ''),
('10679511000001106', ''),
('4383011000001104', ''),
('12329211000001109', ''),
('10678011000001108', ''),
('12333611000001107', ''),
('13845011000001105', ''),
('34025611000001102', ''),
('12059111000001103', ''),
('36640411000001107', ''),
('12391811000001102', ''),
('10681711000001109', ''),
('30996711000001101', ''),
('12332111000001105', ''),
('15248511000001106', ''),
('22083811000001104', ''),
('14730811000001105', ''),
('29745511000001101', ''),
('5104411000001109', ''),
('36125211000001102', ''),
('22827711000001106', ''),
('4047011000001103', ''),
('29746211000001105', ''),
('11055311000001102', ''),
('4046711000001104', ''),
('23939011000001104', ''),
('10065911000001103', ''),
('37901111000001101', ''),
('3879711000001106', ''),
('22154711000001106', ''),
('4635211000001105', ''),
('12391311000001106', ''),
('34026211000001105', ''),
('36129811000001103', ''),
('12329811000001105', ''),
('23430811000001103', ''),
('4047511000001106', ''),
('4383411000001108', ''),
('28797311000001109', ''),
('10679011000001103', ''),
('17474211000001101', ''),
('35576911000001109', ''),
('13845211000001100', ''),
('21636011000001103', ''),
('37996111000001107', ''),
('38895311000001102', ''),
('30823411000001101', ''),
('20227811000001101', ''),
('4000811000001101', ''),
('36044111000001101', ''),
('12391711000001105', ''),
('10267411000001105', ''),
('10684411000001101', ''),
('19671011000001103', ''),
('30994611000001101', ''),
('4478411000001100', ''),
('4752311000001102', ''),
('23939211000001109', ''),
('34025811000001103', ''),
('4485911000001109', ''),
('5104011000001100', ''),
('4382711000001105', ''),
('10267211000001106', ''),
('4476211000001100', ''),
('10681911000001106', ''),
('4048911000001103', ''),
('12390811000001105', ''),
('3385311000001102', ''),
('19671211000001108', ''),
('4049211000001102', ''),
('20506811000001103', ''),
('28797911000001105', ''),
('28991211000001104', ''),
('19723011000001106', '')
GO

-- Query for dmd_3
SELECT * INTO #dmd_3 FROM (
            SELECT
              MedicationIssue.Patient_ID AS patient_id,
              1 AS binary_flag,
              MAX(ConsultationDate) AS date
            FROM MedicationIssue
                INNER JOIN MedicationDictionary
                ON MedicationIssue.MultilexDrug_ID = MedicationDictionary.MultilexDrug_ID
                
            INNER JOIN #tmp2_dmd_3_codelist
            ON DMD_ID = #tmp2_dmd_3_codelist.code
            LEFT JOIN #date_of_death
ON #date_of_death.patient_id = MedicationIssue.patient_id
            WHERE CAST(ConsultationDate AS date) BETWEEN CAST(DATEADD(DAY, -90, CAST(#date_of_death.[date_of_death] AS date)) AS date) AND CAST(CAST(#date_of_death.[date_of_death] AS date) AS date)
              AND NOT 0 = 1
              AND 1 = 1
            GROUP BY MedicationIssue.Patient_ID
            ) t
GO

CREATE CLUSTERED INDEX patient_id_ix ON #dmd_3 (patient_id)
GO


            -- Uploading codelist for dmd_12
            CREATE TABLE #tmp3_dmd_12_codelist (
              code VARCHAR(17) COLLATE Latin1_General_CI_AS NOT NULL PRIMARY KEY,
              category VARCHAR(MAX)
            )
            
GO

INSERT INTO [#tmp3_dmd_12_codelist] ([code], [category]) VALUES
('30947711000001109', ''),
('32480111000001109', ''),
('30823211000001100', ''),
('20418211000001106', ''),
('38895711000001103', ''),
('4049611000001100', ''),
('36125011000001107', ''),
('36128711000001102', ''),
('3246911000001106', ''),
('36128911000001100', ''),
('36130611000001105', ''),
('23958211000001100', ''),
('27953111000001108', ''),
('37995911000001103', ''),
('4383211000001109', ''),
('14729811000001104', ''),
('4048411000001106', ''),
('3880111000001105', ''),
('35537611000001103', ''),
('4486811000001107', ''),
('9750511000001106', ''),
('37761311000001108', ''),
('12333211000001105', ''),
('3242611000001101', ''),
('12058611000001102', ''),
('36124911000001107', ''),
('10066311000001109', ''),
('21555311000001103', ''),
('36125411000001103', ''),
('4486111000001100', ''),
('12391111000001109', ''),
('35576611000001103', ''),
('21627711000001101', ''),
('3385011000001100', ''),
('36128211000001109', ''),
('37760911000001102', ''),
('4383611000001106', ''),
('11487811000001104', ''),
('22401911000001100', ''),
('37995711000001100', ''),
('3245411000001107', ''),
('3383311000001103', ''),
('35584011000001106', ''),
('12391011000001108', ''),
('4476511000001102', ''),
('4477511000001100', ''),
('4049411000001103', ''),
('15545411000001108', ''),
('21579911000001102', ''),
('37605211000001106', ''),
('23430411000001100', ''),
('23430611000001102', ''),
('4636011000001109', ''),
('20419411000001102', ''),
('21678411000001105', ''),
('4478911000001108', ''),
('21540711000001107', ''),
('37761111000001106', ''),
('3384011000001104', ''),
('7978111000001104', ''),
('4508111000001108', ''),
('4182911000001102', ''),
('21507711000001104', ''),
('21579811000001107', ''),
('36128511000001107', ''),
('12391211000001103', ''),
('3247411000001101', ''),
('3245711000001101', ''),
('12334711000001101', ''),
('4045011000001105', ''),
('15613611000001105', ''),
('3880411000001100', ''),
('22402211000001102', ''),
('8436411000001104', ''),
('4752011000001100', ''),
('35537411000001101', ''),
('36053511000001109', ''),
('12335511000001107', ''),
('20275911000001102', ''),
('3879511000001101', ''),
('31994411000001107', ''),
('4046311000001103', ''),
('7977911000001102', ''),
('3823111000001108', ''),
('11055111000001104', ''),
('24403511000001100', ''),
('12391611000001101', ''),
('38895511000001108', ''),
('4477011000001108', ''),
('9748311000001100', ''),
('17474611000001104', ''),
('35537811000001104', ''),
('10075511000001100', ''),
('12332811000001103', ''),
('19710611000001103', ''),
('12336111000001109', ''),
('20507011000001107', ''),
('36641311000001105', ''),
('38896111000001105', ''),
('27858211000001101', ''),
('5104211000001105', ''),
('37388311000001100', ''),
('11488111000001107', ''),
('4486511000001109', ''),
('12391411000001104', ''),
('23607911000001102', ''),
('19711411000001105', ''),
('19711211000001106', ''),
('28991411000001100', ''),
('20275411000001105', ''),
('36125511000001104', ''),
('10679811000001109', ''),
('24403711000001105', ''),
('22658511000001107', ''),
('10679511000001106', ''),
('4383011000001104', ''),
('12329211000001109', ''),
('10678011000001108', ''),
('12333611000001107', ''),
('13845011000001105', ''),
('34025611000001102', ''),
('12059111000001103', ''),
('36640411000001107', ''),
('12391811000001102', ''),
('10681711000001109', ''),
('30996711000001101', ''),
('12332111000001105', ''),
('15248511000001106', ''),
('22083811000001104', ''),
('14730811000001105', ''),
('29745511000001101', ''),
('5104411000001109', ''),
('36125211000001102', ''),
('22827711000001106', ''),
('4047011000001103', ''),
('29746211000001105', ''),
('11055311000001102', ''),
('4046711000001104', ''),
('23939011000001104', ''),
('10065911000001103', ''),
('37901111000001101', ''),
('3879711000001106', ''),
('22154711000001106', ''),
('4635211000001105', ''),
('12391311000001106', ''),
('34026211000001105', ''),
('36129811000001103', ''),
('12329811000001105', ''),
('23430811000001103', ''),
('4047511000001106', ''),
('4383411000001108', ''),
('28797311000001109', ''),
('10679011000001103', ''),
('17474211000001101', ''),
('35576911000001109', ''),
('13845211000001100', ''),
('21636011000001103', ''),
('37996111000001107', ''),
('38895311000001102', ''),
('30823411000001101', ''),
('20227811000001101', ''),
('4000811000001101', ''),
('36044111000001101', ''),
('12391711000001105', ''),
('10267411000001105', ''),
('10684411000001101', ''),
('19671011000001103', ''),
('30994611000001101', ''),
('4478411000001100', ''),
('4752311000001102', ''),
('23939211000001109', ''),
('34025811000001103', ''),
('4485911000001109', ''),
('5104011000001100', ''),
('4382711000001105', ''),
('10267211000001106', ''),
('4476211000001100', ''),
('10681911000001106', ''),
('4048911000001103', ''),
('12390811000001105', ''),
('3385311000001102', ''),
('19671211000001108', ''),
('4049211000001102', ''),
('20506811000001103', ''),
('28797911000001105', ''),
('28991211000001104', ''),
('19723011000001106', '')
GO

-- Query for dmd_12
SELECT * INTO #dmd_12 FROM (
            SELECT
              MedicationIssue.Patient_ID AS patient_id,
              1 AS binary_flag,
              MAX(ConsultationDate) AS date
            FROM MedicationIssue
                INNER JOIN MedicationDictionary
                ON MedicationIssue.MultilexDrug_ID = MedicationDictionary.MultilexDrug_ID
                
            INNER JOIN #tmp3_dmd_12_codelist
            ON DMD_ID = #tmp3_dmd_12_codelist.code
            LEFT JOIN #date_of_death
ON #date_of_death.patient_id = MedicationIssue.patient_id
            WHERE CAST(ConsultationDate AS date) BETWEEN CAST(DATEADD(DAY, -365, CAST(#date_of_death.[date_of_death] AS date)) AS date) AND CAST(CAST(#date_of_death.[date_of_death] AS date) AS date)
              AND NOT 0 = 1
              AND 1 = 1
            GROUP BY MedicationIssue.Patient_ID
            ) t
GO

CREATE CLUSTERED INDEX patient_id_ix ON #dmd_12 (patient_id)
GO

-- Query for has_died
SELECT * INTO #has_died FROM (
        SELECT
          ONS_Deaths.Patient_ID as patient_id,
          1 AS binary_flag
        FROM ONS_Deaths
        
        WHERE (1 = 1) AND CAST(dod AS date) BETWEEN CAST('20190601' AS date) AND CAST('20210228' AS date)
        GROUP BY ONS_Deaths.Patient_ID
        ) t
GO

CREATE CLUSTERED INDEX patient_id_ix ON #has_died (patient_id)
GO

-- Query for registered
SELECT * INTO #registered FROM (
        SELECT DISTINCT Patient.Patient_ID AS patient_id, 1 AS value
        FROM Patient
        INNER JOIN RegistrationHistory
        ON RegistrationHistory.Patient_ID = Patient.Patient_ID
        INNER JOIN Organisation
        ON RegistrationHistory.Organisation_ID = Organisation.Organisation_ID
        LEFT JOIN #date_of_death
ON #date_of_death.patient_id = Patient.patient_id
        WHERE StartDate <= CAST(#date_of_death.[date_of_death] AS date) AND EndDate > CAST(#date_of_death.[date_of_death] AS date)
        
        ) t
GO

CREATE CLUSTERED INDEX patient_id_ix ON #registered (patient_id)
GO

-- Query for sex
SELECT * INTO #sex FROM (
        SELECT
          Patient_ID AS patient_id,
          Sex AS value
        FROM Patient
        ) t
GO

CREATE CLUSTERED INDEX patient_id_ix ON #sex (patient_id)
GO


        -- Join all columns for final output
        SELECT
          Patient.Patient_ID AS [patient_id],
          ISNULL(CONVERT(VARCHAR(10), #date_of_death.[date_of_death], 23), '') AS [date_of_death],
          ISNULL(#died_in_p1.[binary_flag], 0) AS [died_in_p1],
          ISNULL(#died_in_p2.[binary_flag], 0) AS [died_in_p2],
          ISNULL(#dmd_1.[binary_flag], 0) AS [dmd_1],
          ISNULL(#dmd_3.[binary_flag], 0) AS [dmd_3],
          ISNULL(#dmd_12.[binary_flag], 0) AS [dmd_12]
        FROM
          Patient
          LEFT JOIN #date_of_death ON #date_of_death.patient_id = Patient.Patient_ID
          LEFT JOIN #died_in_p1 ON #died_in_p1.patient_id = Patient.Patient_ID
          LEFT JOIN #died_in_p2 ON #died_in_p2.patient_id = Patient.Patient_ID
          LEFT JOIN #dmd_1 ON #dmd_1.patient_id = Patient.Patient_ID
          LEFT JOIN #dmd_3 ON #dmd_3.patient_id = Patient.Patient_ID
          LEFT JOIN #dmd_12 ON #dmd_12.patient_id = Patient.Patient_ID
          LEFT JOIN #has_died ON #has_died.patient_id = Patient.Patient_ID
          LEFT JOIN #registered ON #registered.patient_id = Patient.Patient_ID
          LEFT JOIN #sex ON #sex.patient_id = Patient.Patient_ID
        WHERE CASE WHEN (( ISNULL(#has_died.[binary_flag], 0) != 0 ) AND ( ISNULL(#registered.[value], 0) != 0 ) AND ( ISNULL(#sex.[value], '') = 'F' OR ISNULL(#sex.[value], '') = 'M' )) THEN 1 ELSE 0 END = 1
        
