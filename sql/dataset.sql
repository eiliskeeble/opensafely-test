-- Results query
WITH cte_1 AS 
(SELECT anon_1.patient_id AS patient_id, anon_1.date AS date 
FROM (SELECT ons_deaths.patient_id AS patient_id, ons_deaths.date AS date, row_number() OVER (PARTITION BY ons_deaths.patient_id ORDER BY ons_deaths.date DESC) AS anon_2 
FROM ons_deaths) AS anon_1 
WHERE anon_1.anon_2 = 1), 
cte_8 AS 
(SELECT DISTINCT practice_registrations.patient_id AS patient_id 
FROM practice_registrations LEFT OUTER JOIN cte_1 ON cte_1.patient_id = practice_registrations.patient_id 
WHERE practice_registrations.start_date <= cte_1.date AND (practice_registrations.end_date > cte_1.date OR CASE WHEN (practice_registrations.end_date <= cte_1.date) THEN 1 WHEN (practice_registrations.end_date > cte_1.date) THEN 0 END IS NULL)), 
cte_9 AS 
(SELECT cte_1.patient_id AS patient_id 
FROM cte_1 UNION SELECT cte_8.patient_id AS patient_id 
FROM cte_8 UNION SELECT patients.patient_id AS patient_id 
FROM patients), 
cte_2 AS 
(SELECT DISTINCT medications.patient_id AS patient_id 
FROM medications LEFT OUTER JOIN cte_1 ON cte_1.patient_id = medications.patient_id 
WHERE medications.dmd_code IN ('4383411000001108', '21555311000001103', '28991411000001100', '32480111000001109', '37605211000001106', '35537811000001104', '35584011000001106', '36125511000001104', '14730811000001105', '4049211000001102', '38895711000001103', '30994611000001101', '38895511000001108', '10267211000001106', '20227811000001101', '20275911000001102', '4046311000001103', '36125011000001107', '36128511000001107', '21540711000001107', '22402211000001102', '4752311000001102', '21579811000001107', '34025811000001103', '4635211000001105', '11487811000001104', '34025611000001102', '3880411000001100', '3385311000001102', '13845011000001105', '3385011000001100', '12335511000001107', '4476511000001102', '12391211000001103', '29745511000001101', '34026211000001105', '20418211000001106', '10065911000001103', '22401911000001100', '4049611000001100', '4752011000001100', '12332811000001103', '35576911000001109', '20419411000001102', '36640411000001107', '21627711000001101', '12391611000001101', '12391011000001108', '19711411000001105', '23430411000001100', '38896111000001105', '11055111000001104', '3823111000001108', '10267411000001105', '20275411000001105', '23430811000001103', '3879511000001101', '20507011000001107', '36053511000001109', '36044111000001101', '17474211000001101', '4182911000001102', '10681711000001109', '4478411000001100', '35537411000001101', '37995711000001100', '17474611000001104', '11055311000001102', '36128711000001102', '36641311000001105', '4477511000001100', '4048911000001103', '10684411000001101', '4478911000001108', '5104011000001100', '37901111000001101', '30823211000001100', '4048411000001106', '19711211000001106', '23958211000001100', '12391711000001105', '37388311000001100', '28797311000001109', '19710611000001103', '22658511000001107', '7978111000001104', '12391311000001106', '22083811000001104', '38895311000001102', '5104211000001105', '10679811000001109', '35537611000001103', '13845211000001100', '21636011000001103', '5104411000001109', '4047511000001106', '11488111000001107', '12336111000001109', '37996111000001107', '4485911000001109', '36130611000001105', '12332111000001105', '14729811000001104', '36129811000001103', '37760911000001102', '23430611000001102', '3246911000001106', '10679511000001106', '3245711000001101', '24403711000001105', '23939211000001109', '23939011000001104', '24403511000001100', '21507711000001104', '36124911000001107', '27953111000001108', '12329811000001105', '9750511000001106', '4045011000001105', '12391411000001104', '37761311000001108', '12058611000001102', '36125411000001103', '10678011000001108', '36125211000001102', '23607911000001102', '3242611000001101', '12333611000001107', '3383311000001103', '12329211000001109', '29746211000001105', '4047011000001103', '3247411000001101', '15248511000001106', '7977911000001102', '30996711000001101', '19723011000001106', '28991211000001104', '9748311000001100', '35576611000001103', '37995911000001103', '22154711000001106', '3880111000001105', '19671011000001103', '15545411000001108', '12390811000001105', '19671211000001108', '4383011000001104', '28797911000001105', '3245411000001107', '22827711000001106', '4486111000001100', '30947711000001109', '12333211000001105', '4477011000001108', '21579911000001102', '4476211000001100', '3879711000001106', '12391811000001102', '8436411000001104', '12334711000001101', '10681911000001106', '4383611000001106', '10066311000001109', '4383211000001109', '12059111000001103', '30823411000001101', '4636011000001109', '36128911000001100', '4486511000001109', '27858211000001101', '4049411000001103', '31994411000001107', '37761111000001106', '4486811000001107', '10679011000001103', '4382711000001105', '3384011000001104', '36128211000001109', '20506811000001103', '12391111000001109', '4000811000001101', '4046711000001104', '15613611000001105', '21678411000001105', '4508111000001108', '10075511000001100') AND medications.date >= DATE(DATE(cte_1.date, CAST(-1 AS VARCHAR) || ' months'), CAST(CASE WHEN (CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-1 AS VARCHAR) || ' months')) AS INTEGER) < CAST(STRFTIME('%d', cte_1.date) AS INTEGER)) THEN 1 - CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-1 AS VARCHAR) || ' months')) AS INTEGER) ELSE 0 END AS VARCHAR) || ' days') AND medications.date <= cte_1.date), 
cte_3 AS 
(SELECT DISTINCT medications.patient_id AS patient_id 
FROM medications LEFT OUTER JOIN cte_1 ON cte_1.patient_id = medications.patient_id 
WHERE medications.multilex_code IN ('14319;1;0', '14319;1;3', '14319;1;2') AND medications.date >= DATE(DATE(cte_1.date, CAST(-1 AS VARCHAR) || ' months'), CAST(CASE WHEN (CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-1 AS VARCHAR) || ' months')) AS INTEGER) < CAST(STRFTIME('%d', cte_1.date) AS INTEGER)) THEN 1 - CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-1 AS VARCHAR) || ' months')) AS INTEGER) ELSE 0 END AS VARCHAR) || ' days') AND medications.date <= cte_1.date), 
cte_4 AS 
(SELECT DISTINCT medications.patient_id AS patient_id 
FROM medications LEFT OUTER JOIN cte_1 ON cte_1.patient_id = medications.patient_id 
WHERE medications.dmd_code IN ('4383411000001108', '21555311000001103', '28991411000001100', '32480111000001109', '37605211000001106', '35537811000001104', '35584011000001106', '36125511000001104', '14730811000001105', '4049211000001102', '38895711000001103', '30994611000001101', '38895511000001108', '10267211000001106', '20227811000001101', '20275911000001102', '4046311000001103', '36125011000001107', '36128511000001107', '21540711000001107', '22402211000001102', '4752311000001102', '21579811000001107', '34025811000001103', '4635211000001105', '11487811000001104', '34025611000001102', '3880411000001100', '3385311000001102', '13845011000001105', '3385011000001100', '12335511000001107', '4476511000001102', '12391211000001103', '29745511000001101', '34026211000001105', '20418211000001106', '10065911000001103', '22401911000001100', '4049611000001100', '4752011000001100', '12332811000001103', '35576911000001109', '20419411000001102', '36640411000001107', '21627711000001101', '12391611000001101', '12391011000001108', '19711411000001105', '23430411000001100', '38896111000001105', '11055111000001104', '3823111000001108', '10267411000001105', '20275411000001105', '23430811000001103', '3879511000001101', '20507011000001107', '36053511000001109', '36044111000001101', '17474211000001101', '4182911000001102', '10681711000001109', '4478411000001100', '35537411000001101', '37995711000001100', '17474611000001104', '11055311000001102', '36128711000001102', '36641311000001105', '4477511000001100', '4048911000001103', '10684411000001101', '4478911000001108', '5104011000001100', '37901111000001101', '30823211000001100', '4048411000001106', '19711211000001106', '23958211000001100', '12391711000001105', '37388311000001100', '28797311000001109', '19710611000001103', '22658511000001107', '7978111000001104', '12391311000001106', '22083811000001104', '38895311000001102', '5104211000001105', '10679811000001109', '35537611000001103', '13845211000001100', '21636011000001103', '5104411000001109', '4047511000001106', '11488111000001107', '12336111000001109', '37996111000001107', '4485911000001109', '36130611000001105', '12332111000001105', '14729811000001104', '36129811000001103', '37760911000001102', '23430611000001102', '3246911000001106', '10679511000001106', '3245711000001101', '24403711000001105', '23939211000001109', '23939011000001104', '24403511000001100', '21507711000001104', '36124911000001107', '27953111000001108', '12329811000001105', '9750511000001106', '4045011000001105', '12391411000001104', '37761311000001108', '12058611000001102', '36125411000001103', '10678011000001108', '36125211000001102', '23607911000001102', '3242611000001101', '12333611000001107', '3383311000001103', '12329211000001109', '29746211000001105', '4047011000001103', '3247411000001101', '15248511000001106', '7977911000001102', '30996711000001101', '19723011000001106', '28991211000001104', '9748311000001100', '35576611000001103', '37995911000001103', '22154711000001106', '3880111000001105', '19671011000001103', '15545411000001108', '12390811000001105', '19671211000001108', '4383011000001104', '28797911000001105', '3245411000001107', '22827711000001106', '4486111000001100', '30947711000001109', '12333211000001105', '4477011000001108', '21579911000001102', '4476211000001100', '3879711000001106', '12391811000001102', '8436411000001104', '12334711000001101', '10681911000001106', '4383611000001106', '10066311000001109', '4383211000001109', '12059111000001103', '30823411000001101', '4636011000001109', '36128911000001100', '4486511000001109', '27858211000001101', '4049411000001103', '31994411000001107', '37761111000001106', '4486811000001107', '10679011000001103', '4382711000001105', '3384011000001104', '36128211000001109', '20506811000001103', '12391111000001109', '4000811000001101', '4046711000001104', '15613611000001105', '21678411000001105', '4508111000001108', '10075511000001100') AND medications.date >= DATE(DATE(cte_1.date, CAST(-3 AS VARCHAR) || ' months'), CAST(CASE WHEN (CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-3 AS VARCHAR) || ' months')) AS INTEGER) < CAST(STRFTIME('%d', cte_1.date) AS INTEGER)) THEN 1 - CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-3 AS VARCHAR) || ' months')) AS INTEGER) ELSE 0 END AS VARCHAR) || ' days') AND medications.date <= cte_1.date), 
cte_5 AS 
(SELECT DISTINCT medications.patient_id AS patient_id 
FROM medications LEFT OUTER JOIN cte_1 ON cte_1.patient_id = medications.patient_id 
WHERE medications.multilex_code IN ('14319;1;0', '14319;1;3', '14319;1;2') AND medications.date >= DATE(DATE(cte_1.date, CAST(-3 AS VARCHAR) || ' months'), CAST(CASE WHEN (CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-3 AS VARCHAR) || ' months')) AS INTEGER) < CAST(STRFTIME('%d', cte_1.date) AS INTEGER)) THEN 1 - CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-3 AS VARCHAR) || ' months')) AS INTEGER) ELSE 0 END AS VARCHAR) || ' days') AND medications.date <= cte_1.date), 
cte_6 AS 
(SELECT DISTINCT medications.patient_id AS patient_id 
FROM medications LEFT OUTER JOIN cte_1 ON cte_1.patient_id = medications.patient_id 
WHERE medications.dmd_code IN ('4383411000001108', '21555311000001103', '28991411000001100', '32480111000001109', '37605211000001106', '35537811000001104', '35584011000001106', '36125511000001104', '14730811000001105', '4049211000001102', '38895711000001103', '30994611000001101', '38895511000001108', '10267211000001106', '20227811000001101', '20275911000001102', '4046311000001103', '36125011000001107', '36128511000001107', '21540711000001107', '22402211000001102', '4752311000001102', '21579811000001107', '34025811000001103', '4635211000001105', '11487811000001104', '34025611000001102', '3880411000001100', '3385311000001102', '13845011000001105', '3385011000001100', '12335511000001107', '4476511000001102', '12391211000001103', '29745511000001101', '34026211000001105', '20418211000001106', '10065911000001103', '22401911000001100', '4049611000001100', '4752011000001100', '12332811000001103', '35576911000001109', '20419411000001102', '36640411000001107', '21627711000001101', '12391611000001101', '12391011000001108', '19711411000001105', '23430411000001100', '38896111000001105', '11055111000001104', '3823111000001108', '10267411000001105', '20275411000001105', '23430811000001103', '3879511000001101', '20507011000001107', '36053511000001109', '36044111000001101', '17474211000001101', '4182911000001102', '10681711000001109', '4478411000001100', '35537411000001101', '37995711000001100', '17474611000001104', '11055311000001102', '36128711000001102', '36641311000001105', '4477511000001100', '4048911000001103', '10684411000001101', '4478911000001108', '5104011000001100', '37901111000001101', '30823211000001100', '4048411000001106', '19711211000001106', '23958211000001100', '12391711000001105', '37388311000001100', '28797311000001109', '19710611000001103', '22658511000001107', '7978111000001104', '12391311000001106', '22083811000001104', '38895311000001102', '5104211000001105', '10679811000001109', '35537611000001103', '13845211000001100', '21636011000001103', '5104411000001109', '4047511000001106', '11488111000001107', '12336111000001109', '37996111000001107', '4485911000001109', '36130611000001105', '12332111000001105', '14729811000001104', '36129811000001103', '37760911000001102', '23430611000001102', '3246911000001106', '10679511000001106', '3245711000001101', '24403711000001105', '23939211000001109', '23939011000001104', '24403511000001100', '21507711000001104', '36124911000001107', '27953111000001108', '12329811000001105', '9750511000001106', '4045011000001105', '12391411000001104', '37761311000001108', '12058611000001102', '36125411000001103', '10678011000001108', '36125211000001102', '23607911000001102', '3242611000001101', '12333611000001107', '3383311000001103', '12329211000001109', '29746211000001105', '4047011000001103', '3247411000001101', '15248511000001106', '7977911000001102', '30996711000001101', '19723011000001106', '28991211000001104', '9748311000001100', '35576611000001103', '37995911000001103', '22154711000001106', '3880111000001105', '19671011000001103', '15545411000001108', '12390811000001105', '19671211000001108', '4383011000001104', '28797911000001105', '3245411000001107', '22827711000001106', '4486111000001100', '30947711000001109', '12333211000001105', '4477011000001108', '21579911000001102', '4476211000001100', '3879711000001106', '12391811000001102', '8436411000001104', '12334711000001101', '10681911000001106', '4383611000001106', '10066311000001109', '4383211000001109', '12059111000001103', '30823411000001101', '4636011000001109', '36128911000001100', '4486511000001109', '27858211000001101', '4049411000001103', '31994411000001107', '37761111000001106', '4486811000001107', '10679011000001103', '4382711000001105', '3384011000001104', '36128211000001109', '20506811000001103', '12391111000001109', '4000811000001101', '4046711000001104', '15613611000001105', '21678411000001105', '4508111000001108', '10075511000001100') AND medications.date >= DATE(DATE(cte_1.date, CAST(-12 AS VARCHAR) || ' months'), CAST(CASE WHEN (CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-12 AS VARCHAR) || ' months')) AS INTEGER) < CAST(STRFTIME('%d', cte_1.date) AS INTEGER)) THEN 1 - CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-12 AS VARCHAR) || ' months')) AS INTEGER) ELSE 0 END AS VARCHAR) || ' days') AND medications.date <= cte_1.date), 
cte_7 AS 
(SELECT DISTINCT medications.patient_id AS patient_id 
FROM medications LEFT OUTER JOIN cte_1 ON cte_1.patient_id = medications.patient_id 
WHERE medications.multilex_code IN ('14319;1;0', '14319;1;3', '14319;1;2') AND medications.date >= DATE(DATE(cte_1.date, CAST(-12 AS VARCHAR) || ' months'), CAST(CASE WHEN (CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-12 AS VARCHAR) || ' months')) AS INTEGER) < CAST(STRFTIME('%d', cte_1.date) AS INTEGER)) THEN 1 - CAST(STRFTIME('%d', DATE(cte_1.date, CAST(-12 AS VARCHAR) || ' months')) AS INTEGER) ELSE 0 END AS VARCHAR) || ' days') AND medications.date <= cte_1.date)
 SELECT cte_9.patient_id, CASE WHEN (cte_1.date >= '2019-06-01' AND cte_1.date <= '2020-02-29') THEN 1 WHEN (NOT (cte_1.date >= '2019-06-01' AND cte_1.date <= '2020-02-29')) THEN 0 END AS died_in_p1, CASE WHEN (cte_1.date >= '2020-06-01' AND cte_1.date <= '2021-02-28') THEN 1 WHEN (NOT (cte_1.date >= '2020-06-01' AND cte_1.date <= '2021-02-28')) THEN 0 END AS died_in_p2, CASE WHEN (cte_2.patient_id IS NOT NULL) THEN 1 WHEN (cte_2.patient_id IS NULL) THEN 0 END AS dmd_1, CASE WHEN (cte_3.patient_id IS NOT NULL) THEN 1 WHEN (cte_3.patient_id IS NULL) THEN 0 END AS multilex_1, CASE WHEN (cte_4.patient_id IS NOT NULL) THEN 1 WHEN (cte_4.patient_id IS NULL) THEN 0 END AS dmd_3, CASE WHEN (cte_5.patient_id IS NOT NULL) THEN 1 WHEN (cte_5.patient_id IS NULL) THEN 0 END AS multilex_3, CASE WHEN (cte_6.patient_id IS NOT NULL) THEN 1 WHEN (cte_6.patient_id IS NULL) THEN 0 END AS dmd_12, CASE WHEN (cte_7.patient_id IS NOT NULL) THEN 1 WHEN (cte_7.patient_id IS NULL) THEN 0 END AS multilex_12 
FROM cte_9 LEFT OUTER JOIN cte_1 ON cte_1.patient_id = cte_9.patient_id LEFT OUTER JOIN cte_2 ON cte_2.patient_id = cte_9.patient_id LEFT OUTER JOIN cte_3 ON cte_3.patient_id = cte_9.patient_id LEFT OUTER JOIN cte_4 ON cte_4.patient_id = cte_9.patient_id LEFT OUTER JOIN cte_5 ON cte_5.patient_id = cte_9.patient_id LEFT OUTER JOIN cte_6 ON cte_6.patient_id = cte_9.patient_id LEFT OUTER JOIN cte_7 ON cte_7.patient_id = cte_9.patient_id LEFT OUTER JOIN cte_8 ON cte_8.patient_id = cte_9.patient_id LEFT OUTER JOIN patients ON patients.patient_id = cte_9.patient_id 
WHERE (cte_1.date >= '2019-06-01' AND cte_1.date <= '2020-02-29' OR cte_1.date >= '2020-06-01' AND cte_1.date <= '2021-02-28') AND cte_8.patient_id IS NOT NULL AND patients.sex IN ('male', 'female');

